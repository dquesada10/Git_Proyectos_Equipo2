---
title: "EDA del Dataset del Cancer de Mama"
author: "Autores: Laura Martín, Desiderio Nevado y Daniel Quesada"
date: "Fecha de la publicación: `r Sys.Date()`"
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead[L]{Fundamentos de Análisis de Datos}
output: html_document
---
\begin{center}
\includegraphics[width=100pt]{logotipo_MDS.png}
\vspace{0.5cm}

\includegraphics[width=100pt]{DSLab_logo_1.png}
\end{center}


## Contexto
El dataset objeto de este Exploratory Data Analysis (EDA) es una muestra de mujeres pacientes de cáncer de mama diagnoticadas entre 2006 y 2010. Fue publicado por el programa SEER (Surveillance, Epidemiology and End Results Program) del NCI (National Cancer Institute) en noviembre de 2017.

[Para saber más de NCI](https://www.cancer.gov/about-nci/overview)

[Para saber más del programa SEER](https://seer.cancer.gov/about/overview.html)

Se han excluido de la muestra los pacientes con un tamaño de tumor desconocido o únicamente con ganglios linfaticos examinados y los pacientes que llevaban menos de un mes de supervivencia.

Este dataset ha sido recogido de Kaggle. Se encuentra en la siguiente dirección:

[Dataset Breast Cancer](https://www.kaggle.com/datasets/reihanenamdari/breast-cancer)

<center>
![](https://www.sysmex.es/fileadmin/_processed_/a/9/csm_LifeScience_StageImage_BreastCancer_1500x600-01_2498abd1e0.jpg){width=80%}
</center>

## Descripción de las variables
Describimos las variables para el mejor entendimiento del Dataset:

* **Race**: recoge la raza de las mujeres del dataset. Se divide "white", "black" y "other".

* **Marital Status**: Representa el estado civil de la mujer. Puede tomar los valores de "Married", "Divorced", "Single", "Windowed" o "Separated".

* **T Stage**: La T representa el tamaño y la extension del tumor principal (T de tumor). Puede tomar los valores T1, T2, T3 y T4. Cuanto más grande el número, mayor es el tumor. Si es T1 el tumor es de 2 cm o menos. Si es T2 entonces entre 2 y 5 cm. Si es T3 entonces más de 5 cms. Si es T4 ya se extiende a la piel y a la pared torácica.

* **N Stage**: N se refiere al número de ganglios linfáticos que tienen cancer. Por ello, N1, N2 y N3 se refieren al número de ganglios linfáticos que tienen cáncer.

<center>
![Estados N, T y M](https://epomedicine.com/wp-content/uploads/2016/08/tnm-breast.jpg){width=50%}
</center>

* **6th Stage**: Estado tumoral combinando las clasificaciones de T, N y M (si el tumor está en metastasis), el grado del tumor y los resultados de las pruebas de ER/PR y HER2. Esta información ayuda a saber la diagnosis. Los médicos se refieres a los estados de I a IIA como "estado temprano" y del IIB al III como "avanzado localmente".

<center>
![6th Stage](https://pubs.rsna.org/cms/10.1148/rg.2018180056/asset/images/medium/rg.2018180056.tbl4.gif)
</center>

* **Differentiate**: Toma los valores de "Moderately differentiated", "Poorly differentiated", "Undifferentiated" y "Well differentiated" Carcinomas bien diferenciados tienden a no crecer rapidamente.

* **Grade**: Un grado bajo (1) significa que el cáncer crece lento y es menos probable que crezca y la mayoria de células parecen normales. Un grado alto (3) supone que el cáncer es mucho más probable que crezca y se observan muchas células no normales. Un grado 2 sería algo intermedio entre los dos.

<center>
![Grados de cáncer](https://hips.hearstapps.com/hmg-prod.s3.amazonaws.com/images/gh-breastcancer-gradesofcancer-1540482662.jpg?crop=1xw:1xh;center,top&resize=480:*)
</center>


* **A Stage**: Puede tomar el valor de "Regional" o "Distant". El primero abarcaría los estados I y II y significa que el cancer se ha extendido del pecho a estructuras próximas y ganglios linfáticos. El segundo son los estados III y IV yt significa que se ha extendidos a partes distantes del cuerpo como los pulmones, el hígado y los huesos.
Regional: The cancer has spread outside the breast to nearby structures or lymph nodes.

* **Tumor Size**: Es el tamaño del tumor.

* **Estrogen Status**: Toma los valores de Positivo y Negativo. Si es positivo el cancer crece mas rápido y significa que las células cancerígenas tienen receptores de estrógeno.

* **Progesterone Status**: Toma los valores de Positivo y Negativo. Si es positivo el cancer crece mas rápido y significa que las células cancerígenas tienen receptores de progesterone. Tratamientos con terapia endocrina bloquea el crecimiento de las células cancerosas.

* **Regional Node Examined**: Número de nodos linfáticos examinados.

* **Regional Node Positive**: Número de nodos linfáticos positivos.

* **Survival Months**: Meses que ha sobrevivido el paciente.

* **Status**: Toma los valores de "Alive" y "Dead"

<span style="text-decoration:underline">Explicación variables Estrogen Status y Progesterone Status:</span>

A las células cancerosas del seno obtenidas durante una biopsia o cirugía se le realizarán pruebas para saber si tienen determinadas proteínas que son receptores de estrógeno o progesterona. 
Cuando las hormonas estrógeno y progesterona se unen a estos receptores, estimulan el crecimiento del cáncer. 
A los cánceres se les identifica como cánceres con receptores de hormonas positivos o cánceres con receptores de hormonas negativos según tengan o no estos receptores (proteínas). Saber el estado del receptor hormonal es importante para decidir las opciones de tratamiento.

## Objetivo

Analizar las variables del dataset haciendo un tratamiento y limpieza de los datos para posteriormente comparar los resultados del tratamiento entre diferentes grupos de pacientes como aquellos con cáncer de mama temprano versus tardio así como ver diferentes patrones en las variables. Básicamente se trata de hacer un EDA, es decir, un análisis exploratorio de datos.

A futuro construir un modelo de clasificación para predecir si la paciente sobrevive o no (variable "Status").

## Análisis

Lo primero importamos ciertas librerias que nos pueden ser utiles: dplyr, ggplot2,ggcorrplot, fBasics, tidyr
```{r, include=FALSE,message = FALSE,warning = FALSE}
library(dplyr)
library(ggplot2)
library(ggcorrplot)
library(fBasics)
library(tidyr)
library(gridExtra)
library(caret)
library(readxl)
library(GGally)
library(makedummies)
library(scales)
library(grid)
library(leaps)
library(ggfortify)
```

Damos un primer vistazo a la forma del dataset mirando los primeros registros:
```{r, echo=FALSE}
Breast_Cancer <- read_excel("Breast_Cancer.xlsx")
```

Por otro lado, la estructura de las variables sería la siguiente:

```{r, echo=FALSE}
str(Breast_Cancer)
```
Como se observar que se trata de `r nrow(Breast_Cancer)` observaciones y de las `r ncol(Breast_Cancer)` variables del dataset hay `r sum(sapply(Breast_Cancer, is.integer))` variables integer y el resto son categóricas pero las ha importado como caracter. Además, se puede observar que la variable Reginol.Node.Positive está mal escrita así que vamos a renombrarla.

```{r,echo=FALSE}
Breast_Cancer<-rename(Breast_Cancer,Regional_Node_Positive=Reginol_Node_Positive)
str(as.data.frame(Breast_Cancer$Regional_Node_Positive))
```
Ahora vamos a convertir las varibles chr en factores:
```{r,echo=FALSE}
Breast_Cancer[sapply(Breast_Cancer, is.character)] <- lapply(Breast_Cancer[sapply(Breast_Cancer, is.character)],as.factor)
str(Breast_Cancer[,sapply(Breast_Cancer, is.factor)])
```
Con las variables bien categorizadas como factores podemos ver su distribución:
```{r echo=FALSE}
summary(Breast_Cancer)
```

A simple vista se puede observar lo siguiente:

* La edad media es de 54 años y casi todas están entre 50 y 60 años
* Son mujeres casada en su mayoria
* De media han sobrevivido 6 años y la mayoria están vivas
* El grado del cancer en general es 2 o 3 pero la mayoria esta en unos estados más iniciales y a apenas se les ha extendido por partes distantes del cuerpo 

### Tratamiento datos faltantes
Viendo desde el summary, se observa que hay 19 N/As en algunas variables.

```{r}
sapply(Breast_Cancer, function(x) sum(is.na(x)))
```
Vemos que en alguna algunas variables hay N/A pero son muy pocas. De hecho, suponen un `r round((sum(is.na(Breast_Cancer$Regional_Node_Positive))/count(Breast_Cancer))*100,2)`% del total de los datos. Además, de estos registros no tenemos la variable respuesta (Status) con lo que optamos por eliminarlas.

```{r}
Breast_Cancer_limpio<-Breast_Cancer %>% filter(is.na(Regional_Node_Positive)==FALSE)
```

Ahora volvemos a observar como se destribuyen las variables sin los N/A:

```{r ,echo=FALSE}
summary(Breast_Cancer_limpio)
```

### Transformación de las variables

De las existentes existen 2 que se podrían crear a partir de las anteriores y podrían ser relevantes para analizar:

* Final_Age: supone calcular a traves de la edad cual sería la edad del paciente despues de los meses que ha sobrevivido. Lo podríamos expresar de la siguiente manera:
<center> $redondear(Age + Survival Months/12)$ </center>
* Porc_Reg_N_Pos: supone dividir el número de nodos linfáticos positivos entre el total de examinados. Lo podríamos expresar de la siguiente manera:
<center> $Regional Node Positive / Regional Node Examined$ </center>

```{r}
Breast_Cancer_limpio$Final_Age <- round(Breast_Cancer_limpio$Age +Breast_Cancer_limpio$Survival_Months/12)
Breast_Cancer_limpio$Porc_Reg_N_Pos<-Breast_Cancer_limpio$Regional_Node_Positive/Breast_Cancer_limpio$Regional_Node_Examined
```


### Partición de dataset entre uno de entrenamiento (train) y otro de validación (test)
Antes de empezar con el EDA, siguiendo las buenas prácticas en la construcción de modelos, particionamos el dataset desde el principio entre uno de entrenamiento que es con el que vamos a hacer el EDA y otro de validación para que cuando tengamos el modelo ver si este predice bien sobre unos datos que no ha visto.

Para ello utilizamos la funcion de la libreria Caret.

Primero, para que sea reproducible ponemos una semilla y creamos el dataset de entrenamiento con el 70% de los datos

```{r}
set.seed(1)

particion <- sample(1:nrow(Breast_Cancer_limpio), size = 0.7 * nrow(Breast_Cancer_limpio))

Breast_Cancer_train <- Breast_Cancer_limpio[particion, ]

Breast_Cancer_test <- Breast_Cancer_limpio[-particion, ]
```


### Análisis General

Vamos a separar las variables numéricas de las categóricas:

```{r}
Breast_Cancer_train_num <- Breast_Cancer_train[,names(which(sapply(Breast_Cancer_train, is.numeric)))]
colnames(Breast_Cancer_train_num)
```

```{r}
Breast_Cancer_train_cat <- Breast_Cancer_train[,names(which(sapply(Breast_Cancer_train, is.factor)))]
colnames(Breast_Cancer_train_cat)
```
```{r}
ncol(Breast_Cancer_train_num)
ncol(Breast_Cancer_train_cat)
```
Miramos a alto nivel como se reparte la variable respuesta en el dataset de Train:
```{r include=FALSE,message = FALSE,warning = FALSE}
resumen_status<-data.frame(prop.table(table(Breast_Cancer_train$Status)))
names(resumen_status) <- c("Status", "Freq")

ggplot(resumen_status, aes(x="", y=Freq, fill=Status)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)+
  geom_text(aes(label = scales::percent(Freq)), position = position_stack(vjust = 0.5),color="white")+
  scale_fill_manual(values = c("Alive"="#009999", "Dead"="#cb2e45"))
```

Como se puede observar la mayoria de la muestra sobrevive siendo un  85%.



### Analisis variables numéricas

Primero generamos un boxplot para las variables para entender un poco mejor como se distribuyen:

```{r, echo=FALSE,fig.width=14,fig.height=5.5}
par(cex.axis = 0.8)
boxplot(Breast_Cancer_train_num, main = 'Boxplot de Variables Continuas',
        ylab = "Valores",col = "#009999")
```

Como cada una esta a una escala a veces muy diferente sacamos los logaritmos de todas ellas para ver cuales tienen mas dispersion y que puedan estar en la misma escala:

```{r, echo=FALSE,fig.width=13,fig.height=5.5}
Breast_Cancer_train_num_log <- lapply(Breast_Cancer_train_num, log10)
par(cex.axis = 0.8)
boxplot(Breast_Cancer_train_num_log, main = 'Boxplot de Variables Continuas',
        ylab = "Valores",col = "#009999")
```
Se puede observar lo siguiente:

* Tanto la variable de nodos linfaticos positivos como su transformada del porcentaje de positivos tiene más dispersión que el resto
* La variable survival months no tiene mucha dispersión pero luego tiene muchos datos atípicos.
* Tumor size no tiene mucha dispersión pero también tiene varios datos atípicos por arriba.


Si ahora nos centamos en ver como se distribuyen sus valores en histogramas vemos lo siguiente:

```{r echo=FALSE,warnning=FALSE,fig.width=20,fig.height=10}
vars<-c(strsplit(colnames(Breast_Cancer_train_num), ","))
# Generar un gráfico de densidad para cada variable
plots <- lapply(vars, function(x) {
  ggplot(data = Breast_Cancer_train_num, aes(x = get(x)))+
  geom_histogram(bins=20,fill="#009999", color="grey",alpha = 0.9)+
  xlab(x)+  
  theme_minimal()
}
  )

# Mostrar los gráficos en una sola ventana
grid.arrange(grobs = plots, nrow = 3, ncol = 3)
```

Aqui se puede obsevar como las variables tumor size y survival months tienen colas largas (la primera a la derecha y la segunda a la izquierda) como ya se intuia en el boxplot. 

En general se trata de mujeres en torno a los 50 años que con tamaños no muy grandes de tumores y que han sobrevivido muchos años.

Por otro lado, se ve como los nodos linfaticos positivos siguen como una exponencial.

Ahora, podemos analizar la correlacion entre estas variables pero antes vamos a incluir la variable Status de forma numerica:

```{r echo=FALSE,warnning=FALSE}
Breast_Cancer_train_num_2 <- Breast_Cancer_train_num %>% mutate(Status = ifelse(Breast_Cancer_train$Status == "Alive", 0, 1))
```

```{r echo=FALSE,warnning=FALSE}
ggcorrplot(cor(Breast_Cancer_train_num_2),type = "lower", lab=TRUE)
```


De la matriz de correlaciones lo que se puede resaltar es:

* Que los meses sobrevividos tiene una correlacion inversa lineal con si la mujer fallece por el cancer lo cual tiene mucho sentido.
* También se observa cierta correlación que cuando una mujer tiene detectados más nodos linfáticos positivos más probabilidad tiene de fallecer.
* La siguiente variable con algo de correlacion lineal con los fallecidos es el tamaño del tumor pero ya desde más lejos.

Ahora vamos a visualizar estas variables númericas como se relacionan entre ellas con scatterplots pero segregando entre los que sobreviven y los que no.

```{r echo=FALSE,warnning=FALSE,message=FALSE,fig.width=15,fig.height=10}
Breast_Cancer_train_num_filter <- Breast_Cancer_train_num[,c("Regional_Node_Positive", "Age", "Final_Age", "Porc_Reg_N_Pos","Tumor_Size","Survival_Months")]

ggpairs(Breast_Cancer_train_num_filter, aes(color = Breast_Cancer_train$Status, alpha = 0.5),
        upper = list(continuous = "points"))+
    scale_fill_manual(values = c("Alive"="#009999","Dead"="#cb2e45"))
```

De forma clara unicamente se observa como a menores meses de supervivencia hay mas fallecidas.


### Analisis variables categóricas

Vamos a analizar la distribución de estas:

```{r echo=FALSE,warnning=FALSE,message=FALSE,fig.width=15,fig.height=20}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

plots <- lapply(vars, function(x) {
Breast_Cancer_train %>%
  ggplot(aes(x = get(x), fill = Status)) +
  geom_bar(aes(y = (after_stat(count))/sum(after_stat(count))),position="dodge2") +
  geom_text(aes(y = ((after_stat(count))/sum(after_stat(count))), label = scales::percent((after_stat(count))/sum(after_stat(count)))), stat = "count", 
  position=position_dodge2(width=1), vjust = -0.5, size=4) +
  scale_y_continuous(labels = percent) +
  labs(title = x, y = "Percent", x = x)+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#cb2e45")) 
}
  )

grid.arrange(grobs = plots, nrow = 5, ncol = 2)
```
De estos graficos sobre las variables categóricas, las principales conclusiones es la muestra es principalmente:

* mujeres blancas (que se mueren menos que las negras), 

* de mujeres casadas (que se mueren menos que el resto de grupos - las que mas se mueren son separadas pero no hay muestra suficiente)
```{r echo=FALSE}
round(apply(table(Breast_Cancer_train$Status, Breast_Cancer_train$Marital_Status), 2, prop.table) * 100, 2)
```
* tienen canceres los niveles bajos (1 y 2) del T Stage y sobre todo en N Stage (nivel 1)

* Lo mismo ocurre con el 6th Stage, que están en los niveles bajos asi como con la diferenciación de las celulas cancerigenas, la cual todavia es moderada.

* El grado del cancer es todavia generalmente nivel 2 y A Stage es mayoritariamente Regional.

* Respecto a los niveles de estrogenos y progesterones son mayoritariamente positivos que son tienen menos proporcion de fallecidos.


Viendo esto, vamos a volver a observar las variables pero de otra manera para ver como de significativas son para determinar la probabilidad de fallecimiento:

```{r echo=FALSE,warnning=FALSE,message=FALSE,fig.width=15,fig.height=20}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

for(i in 1:length(vars))
{
x<-colnames(Breast_Cancer_train_cat)[i]

tabla<-Breast_Cancer_train_cat %>%
  group_by(get(x)) %>% 
  summarise(
    total=n(),
     prop_dead = round(sum(Status == "Dead") / total * 100, 2) 
  )
colnames(tabla)[1] = "variable"

grafico<- ggplot(tabla,aes(x = variable)) + 
  geom_col(aes(y = total), fill="#009999",alpha=0.7) + 
  geom_line(aes(y=prop_dead*100 , group=), group = 1,color="#cb2e45") + 
  geom_text(aes(y = prop_dead*100, label = prop_dead),
            vjust = -0.5, color = "red", size = 4) +
  scale_y_continuous(sec.axis = sec_axis(~./100, name = "Proporcion de Fallecidos"))+
  labs(title = x, y = "Total", x = x)+
  theme(plot.title = element_text(hjust = 0.5))+
  labs(y = "Total", x = x)

assign(paste0("grafico_",i), grafico)
}

grid.arrange(grafico_1,grafico_2,grafico_3,grafico_4,grafico_5,grafico_6,grafico_7,grafico_8,grafico_9,grafico_10, nrow = 5, ncol = 2)
```

Resaltan las claras tendencias de todas menos de raza y marital estatus.


### Variables Numericas con Categóricas

Para cerrar el análisis de las variables categóricas vamos a cruzarlas con las numéricas de Survival_Months, Regional_Node_Positive, Porc_Reg_N_Pos y Tumor_Size que son han salido con cierta correlacion y de las categoricas vamos a excluir del analisis la raza y el marital status que no se ha visto que tuvieran mucha relevancia con respecto a los fallecimientos.


```{r echo=FALSE,warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[3]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey", linewidth=0.7)+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```

Las conclusiones de mirar el T Stage es que a mayor nivel de este:

* mayor es el porcentaje de nodos linfaticos positivos encontrados. Esto es interesante porque con la variable numero de nodos positivo no se ve tan claro

* En general salvo para el nivel T4, mayor tamaño del tumor - esta se hubiera esperado que fuera mas clara porque el T Stage es una variable directamente ligada con el tamaño del tumor principal

```{r echo=FALSE,warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[4]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey", size=0.7)+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```
Se observa que el N Stage como se esperaba esta muy ligado al numero o proporcion de nodos positivos encontrados. Es interesante que el N Stage parece no tener nada que ver con numero de meses que se sobrevive.

```{r echo=FALSE,warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[5]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey", size=0.7)+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```
Respecto al 6th Stage se ve muy claramente que a mayor grado mas proporcion de nodos positivos encontrados, lo cual tiene sentido porque supone que esta mas estendido el tumor.


```{r echo=FALSE,warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[6]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey", size=0.7)+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```

En esta variable de diferenciacion se ve claramente que su mayor relacion es con el tamaño del tumor. A mayor diferenciacion mayor tamaño del tumor.


```{r echo=FALSE,warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[7]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey", size=0.7)+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```

Al igual que en la variable anterior el grado de cancer muestra una relacion directa con el tamaño del tumor.

```{r echo=FALSE,warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[8]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey", size=0.7)+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```

Se observa claramente que cuando el A Stage es distante, es decir, esta muy extendido se tiene un tamaño del tumor mucho mas grande y mucha mas proporcion de nodos positivos.

```{r echo=FALSE,warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[9]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey", size=0.7)+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```

Si tienes un estado de estrogenos negativo tiendes a tener mas nodos positivos pero tampoco de manera muy significativa.


```{r echo=FALSE,warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[10]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey", size=0.7)+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```
Con el estado de progesterones tambien con los nodos positivos pero también con el tamaño del tumor.


## Modelización

### Explicación cambio de variable respuesta

Para el objeto de la práctica se pide realizar una regresión lineal multiple es por esto que no tiene sentido continuar con la variable respuesta de nuestra base de datos que es Status (si sobrevive o no) porque sería un modelo de clasificación supervisada.

Es por esto que para el cumplimiento con la práctica vamos a cambiar de variable respuesta a la variable Tumor_Size que es continua.


### Analisis Preliminar

Para entender como se comportan todas respecto a ella vamos categorizar todas y ver como se comporta la media respecto a estas. Para ello vamos a categorizar todas las variables de train.

Volvemos a mirar que variables numéricas teniamos:
```{r echo=FALSE}
colnames(Breast_Cancer_train_num)
```
Categorizamos Edad:
```{r echo=FALSE}
Breast_Cancer_train_num$Age_R <- cut(Breast_Cancer_train_num$Age, breaks = c(25,40,50,60,70,80))
round(prop.table(table(Breast_Cancer_train_num$Age_R))* 100, 2)
```
Categorizamos Edad Final:
```{r echo=FALSE}
Breast_Cancer_train_num$Final_Age_R <- cut(Breast_Cancer_train_num$Final_Age, breaks = c(25,40,50,60,70,80))
round(prop.table(table(Breast_Cancer_train_num$Final_Age_R))* 100, 2)
```
Categorizamos los Survival Months:
```{r echo=FALSE}
Breast_Cancer_train_num$Survival_Months_R <- cut(Breast_Cancer_train_num$Survival_Months, breaks = c(0,30,60,90,120))
round(prop.table(table(Breast_Cancer_train_num$Survival_Months_R))* 100, 2)
```
Categorizamos los nodos positivos:
```{r echo=FALSE}
Breast_Cancer_train_num$Regional_Node_Positive_R <- cut(Breast_Cancer_train_num$Regional_Node_Positive, breaks = c(0,1,3,10,Inf))
round(prop.table(table(Breast_Cancer_train_num$Regional_Node_Positive_R))* 100, 2)
```
Categorizamos los porcentaje de nodos positivos:
```{r echo=FALSE}
Breast_Cancer_train_num$Porc_Reg_N_Pos_R <- cut(Breast_Cancer_train_num$Porc_Reg_N_Pos, breaks = c(0,0.15,0.3,0.5,1))
round(prop.table(table(Breast_Cancer_train_num$Porc_Reg_N_Pos_R))* 100, 2)
```

Ahora analizamos las variables en función del tamaño del tumor:

```{r echo=FALSE,warnning=FALSE,message=FALSE,fig.width=15,fig.height=25}
# Generamos el dataset a analizar
Breast_Cancer_train_num_cat<- Breast_Cancer_train_num %>% 
    select("Age_R","Final_Age_R","Survival_Months_R","Regional_Node_Positive_R","Porc_Reg_N_Pos_R","Tumor_Size")

Breast_Cancer_train_rl <- cbind(Breast_Cancer_train_cat,Breast_Cancer_train_num_cat)


ult_col <- tail(colnames(Breast_Cancer_train_rl), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_rl), ",")), ult_col)

for(i in 1:length(vars))
{
x<-colnames(Breast_Cancer_train_rl)[i]

tabla<-Breast_Cancer_train_rl %>%
  group_by(get(x)) %>% 
  summarise(
    total=n(),
     Tumor_Size_mean = round(mean(Tumor_Size), 2) 
  )
colnames(tabla)[1] = "variable"

grafico<- ggplot(tabla,aes(x = variable)) + 
  geom_col(aes(y = total), fill="#009999",alpha=0.7) + 
  geom_line(aes(y=Tumor_Size_mean*100 -60, group=), group = 1,color="#cb2e45") + 
  geom_text(aes(y = Tumor_Size_mean*100-60, label = Tumor_Size_mean),
            vjust = -0.5, color = "red", size = 4) +
  scale_y_continuous(sec.axis = sec_axis(~./100, name = "Tamaño del Tumor Medio"))+
  labs(title = x, y = "Total", x = x)+
  theme(plot.title = element_text(hjust = 0.5))+
  labs(y = "Total", x = x)
grafico
assign(paste0("grafico_",i), grafico)
}

grid.arrange(grafico_1,grafico_2,grafico_3,grafico_4,grafico_5,grafico_6,grafico_7,grafico_8,grafico_9,grafico_10, grafico_11,grafico_12,grafico_13,
             grafico_14,grafico_15,grafico_16,
             nrow = 8, ncol = 2)
```


De todas las variable presentadas se podrian sacar las siguientes conclusiones:

* Tienen una tendencia clara lineal positiva: N Stage, T Stage, 6th Stage, Regional Node Positive 
* Tienen una cierta tendencia lineal positiva: Grade, Status, Percentage Regional Node Positive
* Tienen una cierta tendencia lineal negativa: Differentiate, Progesterone Status, Age Final, Survival Months
* Tienen una tendencia clara lineal negativa: A Stage
* No tienen masa en los niveles: Estrogen Status
* No tienen tendencia: Age

### Seleccion de variables

Con el metodo forward analizamos las variables que tendria sentido incorporar: 
```{r echo=FALSE,warnning=FALSE,message=FALSE,fig.width=17,fig.height=4}
model <- leaps::regsubsets(Tumor_Size~., Breast_Cancer_train_rl, method="forward")
for (metric in c("r2", "adjr2", "Cp", "bic")){plot(model, scale=metric)}
```



### Procesado de variable calitativas

En base a las que vemos que son significativas, cuando son categoricas tenemos que volverlas numericas, Lo hacemos para las siguientes:

```{r}
Breast_Cancer_train_mod <-Breast_Cancer_train_rl %>%
  
mutate(T_Stage2 = ifelse(Breast_Cancer_train_rl$T_Stage =="T2", 1, 0))  %>%
mutate(T_Stage3 = ifelse(Breast_Cancer_train_rl$T_Stage =="T3", 1, 0))  %>%  
mutate(T_Stage4 = ifelse(Breast_Cancer_train_rl$T_Stage =="T4", 1, 0))  %>%  
  
mutate(N_Stage2 = ifelse(Breast_Cancer_train_rl$N_Stage =="N2", 1, 0))  %>%
  
mutate(sixth_Stage_IIIA = ifelse(Breast_Cancer_train_rl$`6th_Stage` =="IIIA", 1, 0))  %>%
mutate(sixth_Stage_IIIC = ifelse(Breast_Cancer_train_rl$`6th_Stage` =="IIIC", 1, 0))  %>%  
  
mutate(Age_R_70_80 = ifelse(Breast_Cancer_train_rl$Age_R =="(70,80]", 1, 0))  %>%

mutate(differentiate_poorly = ifelse(Breast_Cancer_train_rl$differentiate =="Poorly differentiated", 1, 0))  %>%  
mutate(differentiate_undif = ifelse(Breast_Cancer_train_rl$differentiate =="Undifferentiated", 1, 0)) 
```

### Ajuste, interpretación y diagnosis del modelo

En base a las variables seleccionadas y despúes de haber procesado las variables cualitativas que vamos a incluir en el modelo para volverlas dummie variables (numéricas de 0 y 1), lanzamos el modelo para analizar resultados:

```{r}
model1<- lm(Tumor_Size ~ T_Stage2 + T_Stage3+T_Stage4+N_Stage2+sixth_Stage_IIIA+sixth_Stage_IIIC+differentiate_poorly+
             differentiate_undif+Age_R_70_80, data = Breast_Cancer_train_mod)
summary(model1)
```


```{r}
residuals=model1$residuals
autoplot(model1)
```


```{r}
# install.packages("AppliedPredictiveModeling")
library(AppliedPredictiveModeling)
# Llamamos a los datos
data(concrete)
# Mostramos datos
head(concrete)
```

## Conclusiones

