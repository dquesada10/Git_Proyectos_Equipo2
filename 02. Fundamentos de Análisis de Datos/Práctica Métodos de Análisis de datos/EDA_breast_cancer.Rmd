---
title: "EDA del Dataset del Cancer de Mama"
author: "Autores: Laura Martín, Desiderio Nevado y Daniel Quesada"
date: "Fecha de la publicación: `r Sys.Date()`"
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead[L]{Fundamentos de Análisis de Datos}
output:
  html_document:
    code_folding: hide
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float: yes
link-citations: yes
---

\begin{center}
\includegraphics[width=100pt]{logotipo_MDS.png}
\vspace{0.5cm}

\includegraphics[width=100pt]{DSLab_logo_1.png}
\end{center}


## Contexto
El dataset objeto de este Exploratory Data Analysis (EDA) es una muestra de mujeres pacientes de cáncer de mama diagnoticadas entre 2006 y 2010. Fue publicado por el programa SEER (Surveillance, Epidemiology and End Results Program) del NCI (National Cancer Institute) en noviembre de 2017.

[Para saber más de NCI](https://www.cancer.gov/about-nci/overview)

[Para saber más del programa SEER](https://seer.cancer.gov/about/overview.html)

Se han excluido de la muestra los pacientes con un tamaño de tumor desconocido o únicamente con ganglios linfaticos examinados y los pacientes que llevaban menos de un mes de supervivencia.

Este dataset ha sido recogido de Kaggle. Se encuentra en la siguiente dirección:

[Dataset Breast Cancer](https://www.kaggle.com/datasets/reihanenamdari/breast-cancer)

<center>
![](https://www.sysmex.es/fileadmin/_processed_/a/9/csm_LifeScience_StageImage_BreastCancer_1500x600-01_2498abd1e0.jpg){width=80%}
</center>

## Descripción de las variables
Describimos las variables para el mejor entendimiento del Dataset:

* **Race**: recoge la raza de las mujeres del dataset. Se divide "white", "black" y "other".

* **Marital Status**: Representa el estado civil de la mujer. Puede tomar los valores de "Married", "Divorced", "Single", "Windowed" o "Separated".

* **T Stage**: La T representa el tamaño y la extension del tumor principal (T de tumor). Puede tomar los valores T1, T2, T3 y T4. Cuanto más grande el número, mayor es el tumor. Si es T1 el tumor es de 2 cm o menos. Si es T2 entonces entre 2 y 5 cm. Si es T3 entonces más de 5 cms. Si es T4 ya se extiende a la piel y a la pared torácica.

* **N Stage**: N se refiere al número de ganglios linfáticos que tienen cancer. Por ello, N1, N2 y N3 se refieren al número de ganglios linfáticos que tienen cáncer.

<center>
![Estados N, T y M](https://epomedicine.com/wp-content/uploads/2016/08/tnm-breast.jpg){width=50%}
</center>

* **6th Stage**: Estado tumoral combinando las clasificaciones de T, N y M (si el tumor está en metastasis), el grado del tumor y los resultados de las pruebas de ER/PR y HER2. Esta información ayuda a saber la diagnosis. Los médicos se refieres a los estados de I a IIA como "estado temprano" y del IIB al III como "avanzado localmente".

<center>
![6th Stage](https://pubs.rsna.org/cms/10.1148/rg.2018180056/asset/images/medium/rg.2018180056.tbl4.gif)
</center>

* **Differentiate**: Toma los valores de "Moderately differentiated", "Poorly differentiated", "Undifferentiated" y "Well differentiated" Carcinomas bien diferenciados tienden a no crecer rapidamente.

* **Grade**: Un grado bajo (1) significa que el cáncer crece lento y es menos probable que crezca y la mayoria de células parecen normales. Un grado alto (3) supone que el cáncer es mucho más probable que crezca y se observan muchas células no normales. Un grado 2 sería algo intermedio entre los dos.

<center>
![Grados de cáncer](https://hips.hearstapps.com/hmg-prod.s3.amazonaws.com/images/gh-breastcancer-gradesofcancer-1540482662.jpg?crop=1xw:1xh;center,top&resize=480:*)
</center>


* **A Stage**: Puede tomar el valor de "Regional" o "Distant". El primero abarcaría los estados I y II y significa que el cancer se ha extendido del pecho a estructuras próximas y ganglios linfáticos. El segundo son los estados III y IV yt significa que se ha extendidos a partes distantes del cuerpo como los pulmones, el hígado y los huesos.
Regional: The cancer has spread outside the breast to nearby structures or lymph nodes.

* **Tumor Size**: Es el tamaño del tumor.

* **Estrogen Status**: Toma los valores de Positivo y Negativo. Si es positivo el cancer crece mas rápido y significa que las células cancerígenas tienen receptores de estrógeno.

* **Progesterone Status**: Toma los valores de Positivo y Negativo. Si es positivo el cancer crece mas rápido y significa que las células cancerígenas tienen receptores de progesterone. Tratamientos con terapia endocrina bloquea el crecimiento de las células cancerosas.

* **Regional Node Examined**: Número de nodos linfáticos examinados.

* **Regional Node Positive**: Número de nodos linfáticos positivos.

* **Survival Months**: Meses que ha sobrevivido el paciente.

* **Status**: Toma los valores de "Alive" y "Dead"

<span style="text-decoration:underline">Explicación variables Estrogen Status y Progesterone Status:</span>

A las células cancerosas del seno obtenidas durante una biopsia o cirugía se le realizarán pruebas para saber si tienen determinadas proteínas que son receptores de estrógeno o progesterona. 
Cuando las hormonas estrógeno y progesterona se unen a estos receptores, estimulan el crecimiento del cáncer. 
A los cánceres se les identifica como cánceres con receptores de hormonas positivos o cánceres con receptores de hormonas negativos según tengan o no estos receptores (proteínas). Saber el estado del receptor hormonal es importante para decidir las opciones de tratamiento.

## Objetivo

Analizar las variables del dataset haciendo un tratamiento y limpieza de los datos para posteriormente comparar los resultados del tratamiento entre diferentes grupos de pacientes como aquellos con cáncer de mama temprano versus tardio así como ver diferentes patrones en las variables. Básicamente se trata de hacer un EDA, es decir, un análisis exploratorio de datos.

A futuro construir un modelo de clasificación para predecir si la paciente sobrevive o no (variable "Status").

## Análisis

Lo primero, importamos las librerías que vamos a utilizar en el informe de markdown, así como la version de R que estamos utilizando:
```{r, message = FALSE,warning = FALSE}
library(dplyr)
library(ggplot2)
library(ggcorrplot)
library(fBasics)
library(tidyr)
library(gridExtra)
library(caret)
library(readxl)
library(GGally)
library(makedummies)
library(scales)
library(grid)
library(leaps)
library(ggfortify)
library(AppliedPredictiveModeling)
library(MASS)
```

```{r, echo=FALSE}
version$version.string
```

Miramos los primeros registros del dataset:
```{r}
Breast_Cancer <- read_excel("Breast_Cancer.xlsx")
Breast_Cancer.head(10)
```

Por otro lado, la estructura de las variables sería la siguiente:

```{r}
str(Breast_Cancer)
```
Como se puede observar que se trata de `r nrow(Breast_Cancer)` observaciones y de las `r ncol(Breast_Cancer)` variables del dataset hay `r sum(sapply(Breast_Cancer, is.integer))` variables integer y el resto son categóricas, pero las ha importado como caracter. Además, se puede observar que la variable Reginol.Node.Positive está mal escrita así que la renombramos.

```{r}
Breast_Cancer<-rename(Breast_Cancer,Regional_Node_Positive=Reginol_Node_Positive)
str(as.data.frame(Breast_Cancer$Regional_Node_Positive))
```
Ahora vamos a convertir las varibles chr en factores:
```{r}
Breast_Cancer[sapply(Breast_Cancer, is.character)] <- lapply(Breast_Cancer[sapply(Breast_Cancer, is.character)],as.factor)
str(Breast_Cancer[,sapply(Breast_Cancer, is.factor)])
```
Con las variables bien categorizadas como factores podemos ver su distribución:
```{r}
summary(Breast_Cancer)
```

A simple vista se puede observar lo siguiente:

* La edad media es de 54 años y casi todas están entre 50 y 60 años
* Son mujeres casadas en su mayoría
* De media han sobrevivido 6 años y la mayoría están vivas
* El grado del cancer en general es 2 o 3. La mayoría están en estados iniciales y apenas se han extendido por partes distantes del cuerpo

### Tratamiento datos faltantes
En el summary del dataset se observa que hay 19 N/As en algunas variables.

```{r}
sapply(Breast_Cancer, function(x) sum(is.na(x)))
```

Como los registros con valores N/A en ciertas variables son pocos (un 0.47% del total de los datos) y, además, para estos registros no tenemos la variable respuesta (Status), optamos por eliminarlos.

```{r}
Breast_Cancer_limpio<-Breast_Cancer %>% filter(is.na(Regional_Node_Positive)==FALSE)
```

Ahora volvemos a observar como se destribuyen las variables sin los N/A:

```{r ,echo=FALSE}
summary(Breast_Cancer_limpio)
```


### Partición de dataset en train y test
Antes de empezar con el EDA, siguiendo las buenas prácticas en la construcción de modelos, particionamos el dataset desde el principio entre uno de entrenamiento, que es con el que vamos a hacer el EDA, y otro de validación. De esta forma, cuando tengamos el modelo, podremos ver si este predice bien sobre unos datos que no ha visto.

Para ello utilizamos la funcion de la libreria Caret.

Primero, para que sea reproducible ponemos una semilla y creamos el dataset de entrenamiento con el 70% de los datos

```{r}
set.seed(1)

particion <- sample(1:nrow(Breast_Cancer_limpio), size = 0.7 * nrow(Breast_Cancer_limpio))

Breast_Cancer_train <- Breast_Cancer_limpio[particion, ]

Breast_Cancer_test <- Breast_Cancer_limpio[-particion, ]
```

### Transformación de las variables

Partiendo de las variables del dataset, creamos 2 nuevas variables que podrían ser relevantes para analizar:

* Final_Age: supone calcular a traves de la edad cual sería la edad del paciente después de los meses que ha sobrevivido. Lo podríamos expresar de la siguiente manera:
<center> $redondear(Age + Survival Months/12)$ </center>
* Porc_Reg_N_Pos: supone dividir el número de nodos linfáticos positivos entre el total de examinados. Lo podríamos expresar de la siguiente manera:
<center> $Regional Node Positive / Regional Node Examined$ </center>

```{r}
Breast_Cancer_train$Final_Age <- round(Breast_Cancer_train$Age +Breast_Cancer_train$Survival_Months/12)
Breast_Cancer_train$Porc_Reg_N_Pos<-Breast_Cancer_train$Regional_Node_Positive/Breast_Cancer_train$Regional_Node_Examined
```

### Análisis General

Vamos a separar las variables numéricas de las categóricas:

```{r}
Breast_Cancer_train_num <- Breast_Cancer_train[,names(which(sapply(Breast_Cancer_train, is.numeric)))]
colnames(Breast_Cancer_train_num)
```

```{r}
Breast_Cancer_train_cat <- Breast_Cancer_train[,names(which(sapply(Breast_Cancer_train, is.factor)))]
colnames(Breast_Cancer_train_cat)
```
```{r}
ncol(Breast_Cancer_train_num)
ncol(Breast_Cancer_train_cat)
```
Observamos a alto nivel como se reparte la variable respuesta en el dataset de Train:
```{r message = FALSE,warning = FALSE,fig.width=4,fig.height=4}
resumen_status<-data.frame(prop.table(table(Breast_Cancer_train$Status)))
names(resumen_status) <- c("Status", "Freq")

ggplot(resumen_status, aes(x="", y=Freq, fill=Status)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)+
  geom_text(aes(label = scales::percent(Freq)), position = position_stack(vjust = 0.5),color="white")+
  scale_fill_manual(values = c("Alive"="#009999", "Dead"="#cb2e45"))
```

Como se puede observar la mayoria de la muestra sobrevive, suponiendo un  85%.



### Analisis Univariante:  variables numéricas

Primero generamos un boxplot de las variables para entender un poco mejor como se distribuyen:

```{r fig.width=14,fig.height=5.5}
par(cex.axis = 0.8)
boxplot(Breast_Cancer_train_num, main = 'Boxplot de Variables Continuas',
        ylab = "Valores",col = "#009999")
```

Como cada una tiene una escala, a veces muy diferente, sacamos los logaritmos de todas ellas para ver cuales tienen mas dispersión y que puedan estar en la misma escala:

```{r fig.width=13,fig.height=5.5}
Breast_Cancer_train_num_log <- lapply(Breast_Cancer_train_num, log10)
par(cex.axis = 0.8)
boxplot(Breast_Cancer_train_num_log, main = 'Boxplot de Variables Continuas',
        ylab = "Valores",col = "#009999")
```
Se puede observar lo siguiente:

* Tanto la variable de nodos linfáticos positivos como su transformada del porcentaje de positivos tienen más dispersión que el resto
* La variable survival months no tiene mucha dispersión pero tiene muchos datos atípicos.
* Tumor size no tiene mucha dispersión pero también tiene varios datos atípicos por arriba.


Si ahora nos centramos en ver como se distribuyen sus valores en histogramas vemos lo siguiente:

```{r warnning=FALSE,fig.width=20,fig.height=10}
vars<-c(strsplit(colnames(Breast_Cancer_train_num), ","))
# Generar un gráfico de densidad para cada variable
plots <- lapply(vars, function(x) {
  ggplot(data = Breast_Cancer_train_num, aes(x = get(x)))+
  geom_histogram(bins=20,fill="#009999", color="grey",alpha = 0.9)+
  xlab(x)+  
  theme_minimal()
}
  )

# Mostrar los gráficos en una sola ventana
grid.arrange(grobs = plots, nrow = 3, ncol = 3)
```

Aquí se puede obsevar como las variables tumor size y survival months tienen colas largas (la primera a la derecha y la segunda a la izquierda) como ya se intuía en el boxplot. 

En general se trata de mujeres en torno a los 50 años con tamaños no muy grandes de tumores y que han sobrevivido muchos años.

Por otro lado, se ve como los nodos linfáticos positivos siguen aproximadamente una exponencial.

Ahora, podemos analizar la correlación entre estas variables, pero antes vamos a incluir la variable Status de forma numérica:

```{r warnning=FALSE}
Breast_Cancer_train_num_2 <- Breast_Cancer_train_num %>% mutate(Status = ifelse(Breast_Cancer_train$Status == "Alive", 0, 1))
```

```{r warnning=FALSE}
ggcorrplot(cor(Breast_Cancer_train_num_2),type = "lower", lab=TRUE)
```


De la matriz de correlaciones lo que se puede resaltar es:

* Que los meses sobrevividos tiene una correlacion inversa lineal con si la mujer fallece por el cancer lo cual tiene mucho sentido.
* También se observa cierta correlación que cuando una mujer tiene detectados más nodos linfáticos positivos más probabilidad tiene de fallecer.
* La siguiente variable con algo de correlación lineal con los fallecidos es el tamaño del tumor pero ya desde más lejos.

Ahora vamos a visualizar estas variables númericas como se relacionan entre ellas con scatterplots pero segregando entre los que sobreviven y los que no.

```{r warnning=FALSE,message=FALSE,fig.width=15,fig.height=10}
Breast_Cancer_train_num_filter <- Breast_Cancer_train_num[,c("Regional_Node_Positive", "Age", "Final_Age", "Porc_Reg_N_Pos","Tumor_Size","Survival_Months")]

p<-ggpairs(Breast_Cancer_train_num_filter, aes(color = Breast_Cancer_train$Status, alpha = 0.5),
        upper = list(continuous = "points"))
for(i in 1:p$nrow) {
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j] + 
        scale_fill_manual(values=c("#009999","#cb2e45")) +
        scale_color_manual(values=c("#009999","#cb2e45"))  
  }
}
p
```

De forma clara únicamente se observa como a menores meses de supervivencia hay mas fallecidas.


### Analisis Univariante: variables categóricas

Vamos a analizar la distribución de estas:

```{r warnning=FALSE,message=FALSE,fig.width=15,fig.height=20}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

plots <- lapply(vars, function(x) {
Breast_Cancer_train %>%
  ggplot(aes(x = get(x), fill = Status)) +
  geom_bar(aes(y = (after_stat(count))/sum(after_stat(count))),position="dodge2") +
  geom_text(aes(y = ((after_stat(count))/sum(after_stat(count))), label = scales::percent((after_stat(count))/sum(after_stat(count)))), stat = "count", 
  position=position_dodge2(width=1), vjust = -0.5, size=4) +
  scale_y_continuous(labels = percent) +
  labs(title = x, y = "Percent", x = x)+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#cb2e45")) 
}
  )

grid.arrange(grobs = plots, nrow = 5, ncol = 2)
```
De estos graficos sobre las variables categóricas, las conclusiones en la muestra son principalmente:

* Mujeres blancas (que se mueren menos que las negras)

* Mujeres casadas (que se mueren menos que el resto de grupos - las que mas se mueren son separadas pero no hay muestra suficiente)
```{r}
round(apply(table(Breast_Cancer_train$Status, Breast_Cancer_train$Marital_Status), 2, prop.table) * 100, 2)
```
* Tienen canceres los niveles bajos (1 y 2) del T Stage y sobre todo en N Stage (nivel 1)

* Lo mismo ocurre con el 6th Stage, que está en los niveles bajos. Así como, con la diferenciación de las células cancerígenas, la cual todavía es moderada.

* El grado del cancer es todavía generalmente nivel 2 y A Stage es mayoritariamente Regional.

* Los niveles de estrógenos y progesterones son mayoritariamente positivos, pero fallecen menos.


Viendo esto, vamos a volver a observar las variables, pero de otra manera para ver cómo de significativas son para determinar la probabilidad de fallecimiento:

```{r warnning=FALSE,message=FALSE,fig.width=15,fig.height=20}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

for(i in 1:length(vars))
{
x<-colnames(Breast_Cancer_train_cat)[i]

tabla<-Breast_Cancer_train_cat %>%
  group_by(get(x)) %>% 
  summarise(
    total=n(),
     prop_dead = round(sum(Status == "Dead") / total * 100, 2) 
  )
colnames(tabla)[1] = "variable"


grafico<- ggplot(tabla,aes(x = variable)) + 
  geom_col(aes(y = total), fill="#009999",alpha=0.7) + 
  geom_line(aes(y=prop_dead*100 ), group = 1,color="#cb2e45") + 
  geom_text(aes(y = prop_dead*100, label = prop_dead),
            vjust = -0.5, color = "red", size = 4) +
  scale_y_continuous(sec.axis = sec_axis(~./100, name = "Proporcion de Fallecidos"))+
  labs(title = x, y = "Total", x = x)+
  theme(plot.title = element_text(hjust = 0.5))+
  labs(y = "Total", x = x)

assign(paste0("grafico_",i), grafico)
}

grid.arrange(grafico_1,grafico_2,grafico_3,grafico_4,grafico_5,grafico_6,grafico_7,grafico_8,grafico_9,grafico_10, nrow = 5, ncol = 2)
```

Resaltan las claras tendencias de todas menos de raza y marital estatus.


### Analisis Multivariante:  Numericas con Categóricas

Para cerrar el análisis de las variables categóricas, vamos a cruzarlas con las numéricas. Para ello, de las variables numéricas, elegimos Survival_Months, Regional_Node_Positive, Porc_Reg_N_Pos y Tumor_Size (que son las que han salido con cierta correlacion). De las categóricas, vamos a excluir la raza y el marital status que no se ha visto que tuvieran mucha relevancia con respecto a los fallecimientos.


```{r warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[3]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey")+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```

Las conclusiones de mirar el T Stage es que a mayor nivel de este:

* Mayor es el porcentaje de nodos linfaticos positivos encontrados. Esto es interesante porque con la variable número de nodos positivos no se ve tan claro

* En general salvo para el nivel T4, mayor tamaño del tumor - esta se hubiera esperado que fuera mas clara porque el T Stage es una variable directamente ligada con el tamaño del tumor principal

```{r warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[4]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey")+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```
Se observa que el N Stage, como se esperaba, esta muy ligado al numero o proporcion de nodos positivos encontrados. Es interesante que el N Stage parece no tener nada que ver con numero de meses que se sobrevive.

```{r warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[5]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey", size=0.7)+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```
Respecto al 6th Stage, se ve muy claramente que a mayor grado mas proporción de nodos positivos encontrados, lo cual tiene sentido porque supone que está mas extendido el tumor.


```{r warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[6]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey", size=0.7)+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```

En esta variable de diferenciación se ve claramente que su mayor relación es con el tamaño del tumor. A mayor diferenciación mayor tamaño del tumor.


```{r warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[7]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey", size=0.7)+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```

Al igual que en la variable anterior el grado de cáncer muestra una relación directa con el tamaño del tumor.

```{r warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[8]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey", size=0.7)+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```

Se observa claramente que cuando el A Stage es distante, es decir, está muy extendido, se tiene un tamaño del tumor mucho mas grande y mucha mas proporción de nodos positivos.

```{r warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[9]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey", size=0.7)+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```

Si tienes un estado de estrógenos negativo tiendes a tener mas nodos positivos, pero tampoco de manera muy significativa.


```{r warnning=FALSE,message=FALSE,fig.width=15,fig.height=8}
ult_col <- tail(colnames(Breast_Cancer_train_cat), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_cat), ",")), ult_col)

x<-colnames(Breast_Cancer_train_cat)[10]
agrupar<-c(x,"Status")

vars2<-c("Survival_Months","Regional_Node_Positive","Porc_Reg_N_Pos","Tumor_Size")

plots <- lapply(vars2, function(y) {
  Breast_Cancer_train %>% 
  group_by(across(all_of(agrupar))) %>% 
  summarise(
      mean = mean(get(y)),
      min= min(get(y)),
      max= min(get(y)),      
      sd= sd(get(y)),
      ) %>% 
  ungroup() %>% 
  ggplot(aes(x = get(x), y = mean, fill = Status, group = Status)) + 
  geom_bar(position = "dodge", stat = "identity")+
  geom_text(aes(y = mean, label = round(mean,2)), 
    position=position_dodge2(width=1), vjust = -0.5, size=4) +
  geom_errorbar( aes(x=get(x), ymin=mean-sd, ymax=mean+sd),position = position_dodge(width = 0.8), width=0.3,alpha=0.7, colour="grey", size=0.7)+
  labs(title = y, y = "mean", x = x)+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "top",legend.justification = "left")+
  scale_fill_manual(values = c("Alive"="#009999","Dead"="#d85367")) 
}
  ) 

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```
Con el estado de progesterones también con los nodos positivos, pero también con el tamaño del tumor.


## Modelización

### Explicación cambio de variable respuesta

Para el objeto de la práctica se pide realizar una regresión lineal multiple por lo que no tiene sentido continuar con la variable respuesta de nuestra base de datos, Status (si sobrevive o no), porque sería un modelo de clasificación supervisada.

En consecuencia, para el cumplimiento con la práctica, vamos a cambiar de variable respuesta a la variable Tumor_Size que es continua.


### Analisis Preliminar

Para entender la relación de todas las variables respecto a la variable respuesta, vamos categorizarlas y ver como se comporta su media respecto a esta en train.

Volvemos a mirar que variables numéricas teníamos:
```{r }
colnames(Breast_Cancer_train_num)
```
Categorizamos Edad:
```{r }
Breast_Cancer_train_num$Age_R <- cut(Breast_Cancer_train_num$Age, breaks = c(25,40,50,60,70,80))
round(prop.table(table(Breast_Cancer_train_num$Age_R))* 100, 2)
```
Categorizamos Edad Final:
```{r }
Breast_Cancer_train_num$Final_Age_R <- cut(Breast_Cancer_train_num$Final_Age, breaks = c(25,40,50,60,70,80))
round(prop.table(table(Breast_Cancer_train_num$Final_Age_R))* 100, 2)
```
Categorizamos los Survival Months:
```{r }
Breast_Cancer_train_num$Survival_Months_R <- cut(Breast_Cancer_train_num$Survival_Months, breaks = c(0,30,60,90,120))
round(prop.table(table(Breast_Cancer_train_num$Survival_Months_R))* 100, 2)
```
Categorizamos los nodos positivos:
```{r }
Breast_Cancer_train_num$Regional_Node_Positive_R <- cut(Breast_Cancer_train_num$Regional_Node_Positive, breaks = c(0,1,3,10,Inf))
round(prop.table(table(Breast_Cancer_train_num$Regional_Node_Positive_R))* 100, 2)
```
Categorizamos los porcentaje de nodos positivos:
```{r }
Breast_Cancer_train_num$Porc_Reg_N_Pos_R <- cut(Breast_Cancer_train_num$Porc_Reg_N_Pos, breaks = c(0,0.15,0.3,0.5,1))
round(prop.table(table(Breast_Cancer_train_num$Porc_Reg_N_Pos_R))* 100, 2)
```

Ahora analizamos las variables en función del tamaño del tumor:

```{r warnning=FALSE,message=FALSE,fig.width=15,fig.height=25}
# Generamos el dataset a analizar
Breast_Cancer_train_num_cat<- Breast_Cancer_train_num[,c("Age_R","Final_Age_R","Survival_Months_R","Regional_Node_Positive_R","Porc_Reg_N_Pos_R","Tumor_Size")]
Breast_Cancer_train_rl <- cbind(Breast_Cancer_train_cat,Breast_Cancer_train_num_cat)


ult_col <- tail(colnames(Breast_Cancer_train_rl), n = 1)
vars<-setdiff(c(strsplit(colnames(Breast_Cancer_train_rl), ",")), ult_col)

for(i in 1:length(vars))
{
x<-colnames(Breast_Cancer_train_rl)[i]

tabla<-Breast_Cancer_train_rl %>%
  group_by(get(x)) %>% 
  summarise(
    total=n(),
     Tumor_Size_mean = round(mean(Tumor_Size), 2) 
  )
colnames(tabla)[1] = "variable"

grafico<- ggplot(tabla,aes(x = variable)) + 
  geom_col(aes(y = total), fill="#009999",alpha=0.7) + 
  geom_line(aes(y=Tumor_Size_mean*100 -60), group = 1,color="#cb2e45") + 
  geom_text(aes(y = Tumor_Size_mean*100-60, label = Tumor_Size_mean),
            vjust = -0.5, color = "red", size = 4) +
  scale_y_continuous(sec.axis = sec_axis(~./100, name = "Tamaño del Tumor Medio"))+
  labs(title = x, y = "Total", x = x)+
  theme(plot.title = element_text(hjust = 0.5))+
  labs(y = "Total", x = x)
grafico
assign(paste0("grafico_",i), grafico)
}

grid.arrange(grafico_1,grafico_2,grafico_3,grafico_4,grafico_5,grafico_6,grafico_7,grafico_8,grafico_9,grafico_10, grafico_11,grafico_12,grafico_13,
             grafico_14,grafico_15,grafico_16,
             nrow = 8, ncol = 2)
```


De todas las variable presentadas se podrían sacar las siguientes conclusiones:

* Tienen una tendencia clara lineal positiva: N Stage, T Stage, 6th Stage, Regional Node Positive 
* Tienen una cierta tendencia lineal positiva: Grade, Status, Percentage Regional Node Positive
* Tienen una cierta tendencia lineal negativa: Differentiate, Progesterone Status, Age Final, Survival Months
* Tienen una tendencia clara lineal negativa: A Stage
* No tienen masa en los niveles: Estrogen Status
* No tienen tendencia: Age

### Seleccion de variables

Vamos a empezar haciendo un modelo de regresión lineal multiple incluyendo todas las variables para ver de un primer vistazo cuales son mas significativas para predecir la variable Tumor_Size (nombre del modelo: modelo_inicial1):

```{r}
modelo_inicial1 <- lm(Tumor_Size~., data=Breast_Cancer_train_rl)
summary(modelo_inicial1)
```

Se puede observar que la variable T Stage es significativa ya que sus p-valores son < 0.05 por lo que se rechazaría la hipótesis que el coeficiente sea 0.

Esto también se observa con la variable 6th_Stage para el nivel IIIA así como para ciertos niveles del número de nodos positivos.

El R² ajustado es de un 76% por lo que no está mal el modelo, pero incluye muchas variables que no son significativas para predecir la variable respuesta y que añaden complejidad al modelo.

Es por esto que hacemos la prueba de lanzar el modelo únicamente con las 3 variables que salieron más significativas (nombre del modelo: modelo_inicial2):

```{r}
modelo_inicial2 <- lm(Tumor_Size~ T_Stage+`6th_Stage`+Regional_Node_Positive_R, data=Breast_Cancer_train_rl)
summary(modelo_inicial2)
```

El modelo vuelve a salir con un R² ajustado muy parecido.

Antes de realizar el procesado de las variables cualitativas, vamos a utilizar una de las técnicas automáticas de selección de variables, en particular, vamos a utilizar el metodo forward para analizar las variables que tendría sentido incorporar: 
```{r, warnning=FALSE, message=FALSE, fig.width=17, fig.height=4}
model <- leaps::regsubsets(Tumor_Size~., Breast_Cancer_train_rl, method="forward")
for (metric in c("r2", "adjr2", "Cp", "bic")){plot(model, scale=metric)}
```

Las conclusiones son muy parecidas aunque ahora una variable como Regional_Node_Positive_R(3,10] la descarta y sin embargo considera meter algún nivel de la variable differentiate.


### Procesado de variable cualitativas

Volvemos a poner en formato numérico las variables que han salido significativas anteriormente.

```{r}
Breast_Cancer_train_mod <-Breast_Cancer_train_rl %>%
  
mutate(T_Stage2 = ifelse(Breast_Cancer_train_rl$T_Stage =="T2", 1, 0))  %>%
mutate(T_Stage3 = ifelse(Breast_Cancer_train_rl$T_Stage =="T3", 1, 0))  %>%  
mutate(T_Stage4 = ifelse(Breast_Cancer_train_rl$T_Stage =="T4", 1, 0))  %>%  
  
mutate(N_Stage2 = ifelse(Breast_Cancer_train_rl$N_Stage =="N2", 1, 0))  %>%
  
mutate(sixth_Stage_IIIA = ifelse(Breast_Cancer_train_rl$`6th_Stage` =="IIIA", 1, 0))  %>%
mutate(sixth_Stage_IIIC = ifelse(Breast_Cancer_train_rl$`6th_Stage` =="IIIC", 1, 0))  %>%  
  
mutate(Age_R_70_80 = ifelse(Breast_Cancer_train_rl$Age_R =="(70,80]", 1, 0))  %>%
  
mutate(Regional_Node_Positive_R_3_10 = ifelse(Breast_Cancer_train_rl$Regional_Node_Positive_R =="(3,10]", 1, 0))  %>%  

mutate(differentiate_poorly = ifelse(Breast_Cancer_train_rl$differentiate =="Poorly differentiated", 1, 0))  %>%  
mutate(differentiate_undif = ifelse(Breast_Cancer_train_rl$differentiate =="Undifferentiated", 1, 0)) 
```

### Ajuste, interpretación y diagnosis del modelo

En base a las variables seleccionadas y despúes de haber procesado las variables cualitativas que vamos a incluir en el modelo para convertirlas en variables dummie (numéricas de 0 y 1), lanzamos el modelo para analizar resultados (nombre del modelo: modelo1):

```{r}
modelo1<- lm(Tumor_Size ~ T_Stage2 + T_Stage3+T_Stage4+N_Stage2+sixth_Stage_IIIA+sixth_Stage_IIIC+differentiate_poorly+
             differentiate_undif+Age_R_70_80+Regional_Node_Positive_R_3_10, data = Breast_Cancer_train_mod)
summary(modelo1)
```

Como observamos que las 3 últimas variables o no han entrado porque no tenían valores aunque con el método forward salia que se tenían que incluir o no son tan significativas como es el caso de differentiate para "Poorly differentiated" o por ejemplo el rango de nodos positivos ya que sale un p-valor de 0.08, con lo que no se puede rechazar la hipótesis nula (coeficiente de 0).

Por tanto, optamos por hacer un nuevo modelo en el que las eliminamos (nombre del modelo: modelo2):
```{r}
modelo2<- lm(Tumor_Size ~ T_Stage2 + T_Stage3+T_Stage4+N_Stage2+sixth_Stage_IIIA+sixth_Stage_IIIC, data = Breast_Cancer_train_mod)
summary(modelo2)
```

Como se puede observar en el nuevo modelo nos quedamos muy parecidos de $R^2 Ajustado$ pero quitamos complejidad al modelo.

```{r}
residuals=modelo2$residuals
autoplot(modelo2)
```

Observando los resudios del modelo, podemos concluir que no es muy bueno porque estos no se distribuyen de manera normal. Además, se observa un ligero grado de heterocedasticidad en el modelo, ya que la dispersión aumenta conforme aumentan los valores de la variable respuesta.

Antes de pasar a hacer un backtest sobre este modelo2, vamos a comparar los distintos modelos creados usando el estadístico BIC:

```{r}
paste0("BIC del modelo_inicial1: ",BIC(modelo_inicial1))
paste0("BIC del modelo_inicial2: ",BIC(modelo_inicial2))
paste0("BIC del modelo1: ",BIC(modelo1))
paste0("BIC del modelo2: ",BIC(modelo2))
```

Se observa que el modelo 2 es el mejor porque aún teniendo una capacidad de predecir similar utiliza menos parámetros (el BIC penaliza los modelos muy complejos que pueden generar overfitting).

Los coeficientes del modelo elegido (modelo2) son los siguientes:

```{r}
coef(modelo2)
```

Por último, vamos a mirar que variables saldrian significativas si no utilizaramos las variables T_Stage, N_Stage o sixth_Stage. Al final, estas variables están directamente ligadas al tamaño del tumor, sobre todo T_Stage y sixth Stage que a su vez engloba al concepto de T_Stage porque T_Stage toma niveles en función del tamaño del tumor. Es verdad que el resto de variables también son descriptivas del grado de cancer salvo la edad, la raza y el marital status y lo interesante sería disponer de más variables como estas últimas para tratar de predecir el tamaño del tumor, es decir, variables sobre el estilo de vida de la persona (fuma/no fuma), sobre otras caracteristicas de la persona (peso) o geográficas (codigo postal, ciudad/campo...) por poner varios ejemplos.

```{r}
modelo_prueba <- lm(Tumor_Size~.-T_Stage-N_Stage-`6th_Stage`, data=Breast_Cancer_train_rl)
summary(modelo_prueba)
```

Los resultados son interesantes ya que ahora salen los niveles de nº de nodos positivos como significativa asi como el porcentaje de nodos positivos sobre los examinados o una variable de las que comentabamos anteriormente que no tiene que ver con el grado del cáncer como la edad en el rango de personas mas mayores de la muestra. En cualquier caso, se observa que no disponemos de variables para predecir el tamaño del tumor si no utilizamos las obvias ya que el R² ajustado cae a un 12%.

### Backtest contra el dataset de test

Ahora vamos a recoger el data set test y le vamos a lanzar el modelo.

Una vez lanzado, vamos a ordenar el tamaño del tumor de menor a mayor en el dataset de validación y partir el dataset en 10 partes iguales (las primeras partes saran las de las pacientes de tamaño del tumor mas pequeño).

Por último, vamos a comparar los resultados por estos grupos para ver si el tumor medio real es muy distinto al predecido.

```{r}
Breast_Cancer_test_mod<-Breast_Cancer_test %>%
  mutate(T_Stage2 = ifelse(Breast_Cancer_test$T_Stage =="T2", 1, 0))  %>%
  mutate(T_Stage3 = ifelse(Breast_Cancer_test$T_Stage =="T3", 1, 0))  %>%  
  mutate(T_Stage4 = ifelse(Breast_Cancer_test$T_Stage =="T4", 1, 0))  %>%  
  
  mutate(N_Stage2 = ifelse(Breast_Cancer_test$N_Stage =="N2", 1, 0))  %>%
  
  mutate(sixth_Stage_IIIA = ifelse(Breast_Cancer_test$`6th_Stage` =="IIIA", 1, 0))  %>%
  mutate(sixth_Stage_IIIC = ifelse(Breast_Cancer_test$`6th_Stage` =="IIIC", 1, 0))  %>%  
  mutate(Tumor_Size_pred=13.882591+17.022325*T_Stage2+59.460244*T_Stage3+39.296580*T_Stage4
         +5.519828*N_Stage2+-4.083976*sixth_Stage_IIIA+2.555117*sixth_Stage_IIIC) %>%
  arrange(Tumor_Size)

Breast_Cancer_test_mod$grupo <- ntile(Breast_Cancer_test_mod$Tumor_Size, n = 10)

tabla<-Breast_Cancer_test_mod %>%
  group_by(grupo) %>% 
  summarise(
    total=n(),
    Tumor_Size_mean = round(mean(Tumor_Size), 2),
    Tumor_Size_pred_mean = round(mean(Tumor_Size_pred), 2) 
  )
ggplot(tabla,aes(x = grupo)) + 
  geom_col(aes(y = total), fill="#009999",alpha=0.7) +
  geom_line(aes(y=Tumor_Size_mean+50), group = 1,color="#cb2e45") +
  geom_text(aes(y = Tumor_Size_mean+50, label = Tumor_Size_mean),
            vjust = -1.5, color = "red", size = 4) +
  geom_line(aes(y = Tumor_Size_pred_mean+50), color = "blue") +
    geom_text(aes(y = Tumor_Size_pred_mean+50, label = Tumor_Size_pred_mean),
            vjust = 1.5, color = "blue", size = 4) +
  scale_y_continuous(sec.axis = sec_axis(~.-50, name = "Tamaño del Tumor Medio"))+
  labs(title = "Validacion del modelo sobre la var. respuesta Tumor_Size", y = "Total")+
  theme(plot.title = element_text(hjust = 0.5))
```

Viendo los resultados, se observa que, en general, predice muy bien sobre el dataset de test con lo que parece que el modelo funciona.

Ahora vamos a hacer cross validation, que basicamente significa que se particiona el dataset de train en k partes y cada parte se divide a su vez en un subset de train y de test. Se lanza el modelo para las k partes y luego se promedian los resultados. Para poder determinar que nuestro modelo seleccionado es robusto (modelo2), nuestros coeficientes resultantes del cross validation deberían ser parecidos.

Primero creamos la función resumen en la que definimos que vamos a hacer 10 particiones
```{r}
mi_control<-trainControl(method="cv",number=10,verboseIter = TRUE)
```


Ahora rehacemos la regresion lineal del modelo2 pero poniendo el control de arriba
```{r}
modelo3<-train(Tumor_Size ~ T_Stage2 + T_Stage3+T_Stage4+N_Stage2+sixth_Stage_IIIA+sixth_Stage_IIIC, data = Breast_Cancer_train_mod,method="lm",trControl=mi_control)
```

Se puede observar como ha entrado el modelo en cada una de las 5 partes

```{r}
modelo3
```
Se ve que el R² promediado de lanzar los modelos en todas las particiones es muy parecido del que salía en el anterior apartado.

Ahora vamos a mirar los coeficientes resultantes tanto en el modelo seleccionado (modelo2) como en el del cross validation:

```{r}
coef(modelo2)
```

```{r}
summary(modelo3)
```

Comparando los coeficientes se observa que son muy parecidos en el modelo 2 y en este modelo promediado de las particiones con lo que se podria decir que es un modelo robusto.


## Conclusiones

* La muestra recoge mujeres pacientes de cáncer de mama que en general están entre los 50 y 60 años, son blancas, están casadas, han sobrevivido en torno a 6 años y con niveles de cáncer de mama moderados según los distintos paramentros del nivel de cáncer del dataset. De ahí que al final del estudio un 85% hayan sobrevivido.
* Únicamente habia 19 datos faltantes que se han eliminado porque no suponían más que el 0.47% de la muestra y no incluían la variable respuesta que es si sobreviven o no.
* Respecto a las correlaciones entre las variables numéricas:
  + Se observa que los meses sobrevividos tienen una correlacion inversa lineal con si la mujer fallece.
  + Existe cierta correlación de que cuando una mujer tiene detectados más nodos linfáticos positivos o tiene un mayor tamaño del tumor, hay más probabilidad tiene de fallecer.
* En las variables categóricas se ve que hay tendencias con respecto a la probabilidad de fallecimiento menos en las variables de raza y estado civil donde no se observa ningún patrón claro.
* Para hacer la regresión lineal multiple hemos elegido como variable respuesta el tamaño del tumor porque con la variable status (si ha fallecido o no) no se podría hacer ya que se trataria de un problema de clasificación supervisada.
* El modelo resultante pasa el backtest y en el cross validation se observa que los coeficientes no varían apenas. Tiene un R² ajustado relativamente aceptable de un 76% y si bien los residuos no se distribuyen de forma normal, la variable respuesta se predice relativamente bien con pocas variables explicativas (T_Stage, N_State y 6thStage). Sin embargo, el problema del modelo es que predecimos la variable respuesta con variables que en el fondo hablan de esta y son meras clasificaciones del grado de cáncer. De hecho, si tratamos de hacer el modelo sin incluir estas variables los resultados son muy pobres ya que no disponemos de otras variables que tengan relación con la variable respuesta y que no esten ligadas al grado de cáncer.
