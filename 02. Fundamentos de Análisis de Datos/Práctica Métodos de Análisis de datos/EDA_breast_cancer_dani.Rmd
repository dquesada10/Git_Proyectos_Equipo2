---
title: "EDA del Dataset del Cancer de Mama"
author: "Autores: Laura Martín, Desiderio Nevado y Daniel Quesada"
date: "Fecha de la publicación: `r Sys.Date()`"
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead[L]{Fundamentos de Análisis de Datos}
output: html_document
---
\begin{center}
\includegraphics[width=100pt]{logotipo_MDS.png}
\vspace{0.5cm}

\includegraphics[width=100pt]{DSLab_logo_1.png}
\end{center}


## Contexto
El dataset objeto de este Exploratory Data Analysis (EDA) es una muestra de mujeres pacientes de cáncer de mama diagnoticadas entre 2006 y 2010. Fue publicado por el programa SEER (Surveillance, Epidemiology and End Results Program) del NCI (National Cancer Institute) en noviembre de 2017.

[Para saber más de NCI](https://www.cancer.gov/about-nci/overview)

[Para saber más del programa SEER](https://seer.cancer.gov/about/overview.html)

Se han excluido de la muestra los pacientes con un tamaño de tumor desconocido o únicamente con ganglios linfaticos examinados y los pacientes que llevaban menos de un mes de supervivencia.

Este dataset ha sido recogido de Kaggle. Se encuentra en la siguiente dirección:

[Dataset Breast Cancer](https://www.kaggle.com/datasets/reihanenamdari/breast-cancer)

<center>
![](https://www.sysmex.es/fileadmin/_processed_/a/9/csm_LifeScience_StageImage_BreastCancer_1500x600-01_2498abd1e0.jpg){width=80%}
</center>

## Descripción de las variables
Describimos las variables para el mejor entendimiento del Dataset:

* **Race**: recoge la raza de las mujeres del dataset. Se divide "white", "black" y "other".

* **Marital Status**: Representa el estado civil de la mujer. Puede tomar los valores de "Married", "Divorced", "Single", "Windowed" o "Separated".

* **T Stage**: La T representa el tamaño y la extension del tumor principal (T de tumor). Puede tomar los valores T1, T2, T3 y T4. Cuanto más grande el número, mayor es el tumor. Si es T1 el tumor es de 2 cm o menos. Si es T2 entonces entre 2 y 5 cm. Si es T3 entonces más de 5 cms. Si es T4 ya se extiende a la piel y a la pared torácica.

* **N Stage**: N se refiere al número de ganglios linfáticos que tienen cancer. Por ello, N1, N2 y N3 se refieren al número de ganglios linfáticos que tienen cáncer.

<center>
![Estados N, T y M](https://epomedicine.com/wp-content/uploads/2016/08/tnm-breast.jpg){width=50%}
</center>

* **6th Stage**: Estado tumoral combinando las clasificaciones de T, N y M (si el tumor está en metastasis), el grado del tumor y los resultados de las pruebas de ER/PR y HER2. Esta información ayuda a saber la diagnosis. Los médicos se refieres a los estados de I a IIA como "estado temprano" y del IIB al III como "avanzado localmente".

<center>
![6th Stage](https://pubs.rsna.org/cms/10.1148/rg.2018180056/asset/images/medium/rg.2018180056.tbl4.gif)
</center>

* **Differentiate**: Toma los valores de "Moderately differentiated", "Poorly dufferebtuated", "Undifferentiated" y "Well differentiated" Carcinomas bien diferenciados tienden a no crecer rapidamente.

* **Grade**: Un grado bajo (1) significa que el cáncer crece lento y es menos probable que crezca y la mayoria de células parecen normales. Un grado alto (3) supone que el cáncer es mucho más probable que crezca y se observan muchas células no normales. Un grado 2 sería algo intermedio entre los dos.

<center>
![Grados de cáncer](https://hips.hearstapps.com/hmg-prod.s3.amazonaws.com/images/gh-breastcancer-gradesofcancer-1540482662.jpg?crop=1xw:1xh;center,top&resize=480:*)
</center>


* **A Stage**: Puede tomar el valor de "Regional" o "Distant". El primero abarcaría los estados I y II y significa que el cancer se ha extendido del pecho a estructuras próximas y ganglios linfáticos. El segundo son los estados III y IV yt significa que se ha extendidos a partes distantes del cuerpo como los pulmones, el hígado y los huesos.
Regional: The cancer has spread outside the breast to nearby structures or lymph nodes.

* **Tumor Size**: Es el tamaño del tumor.

* **Estrogen Status**: Toma los valores de Positivo y Negativo. Si es positivo el cancer crece mas rápido y significa que las células cancerígenas tienen receptores de estrógeno.

* **Progesterone Status**: Toma los valores de Positivo y Negativo. Si es positivo el cancer crece mas rápido y significa que las células cancerígenas tienen receptores de progesterone. Tratamientos con terapia endocrina bloquea el crecimiento de las células cancerosas.

* **Regional Node Examined**: Número de nodos linfáticos examinados.

* **Regional Node Positive**: Número de nodos linfáticos positivos.

* **Survival Months**: Meses que ha sobrevivido el paciente.

* **Status**: Toma los valores de "Alive" y "Dead"

<span style="text-decoration:underline">Explicación variables Estrogen Status y Progesterone Status:</span>

A las células cancerosas del seno obtenidas durante una biopsia o cirugía se le realizarán pruebas para saber si tienen determinadas proteínas que son receptores de estrógeno o progesterona. 
Cuando las hormonas estrógeno y progesterona se unen a estos receptores, estimulan el crecimiento del cáncer. 
A los cánceres se les identifica como cánceres con receptores de hormonas positivos o cánceres con receptores de hormonas negativos según tengan o no estos receptores (proteínas). Saber el estado del receptor hormonal es importante para decidir las opciones de tratamiento.

## Objetivo

Analizar las variables del dataset haciendo un tratamiento y limpieza de los datos para posteriormente comparar los resultados del tratamiento entre diferentes grupos de pacientes como aquellos con cáncer de mama temprano versus tardio así como ver diferentes patrones en las variables. Básicamente se trata de hacer un EDA, es decir, un análisis exploratorio de datos.

A futuro construir un modelo de clasificación para predecir si la paciente sobrevive o no (variable "Status").

## Análisis

Lo primero importamos ciertas librerias que nos pueden ser utiles: dplyr, ggplot2,ggcorrplot, fBasics, tidyr
```{r, include=FALSE,message = FALSE,warning = FALSE}
library(dplyr)
library(ggplot2)
library(ggcorrplot)
library(fBasics)
library(tidyr)
library(gridExtra)
library(caret)
library(readxl)
```
Definimos algunas funciones que nos van a ser utiles:
```{r}
Cv <- function(mean, sd){(sd/mean)*100}
```


Damos un primer vistazo a la forma del dataset mirando los primeros registros:
```{r, echo=FALSE}
Breast_Cancer <- read_excel("Breast_Cancer.xlsx")
```

Por otro lado, la estructura de las variables sería la siguiente:

```{r, echo=FALSE}
str(Breast_Cancer)
```
Como se observar que se trata de `r nrow(Breast_Cancer)` observaciones y de las `r ncol(Breast_Cancer)` variables del dataset hay `r sum(sapply(Breast_Cancer, is.integer))` variables integer y el resto son categóricas pero las ha importado como caracter. Además, se puede observar que la variable Reginol.Node.Positive está mal escrita así que vamos a renombrarla.

```{r,echo=FALSE}
Breast_Cancer<-rename(Breast_Cancer,Regional_Node_Positive=Reginol_Node_Positive)
str(as.data.frame(Breast_Cancer$Regional_Node_Positive))
```
Ahora vamos a convertir las varibles chr en factores:
```{r,echo=FALSE}
Breast_Cancer[sapply(Breast_Cancer, is.character)] <- lapply(Breast_Cancer[sapply(Breast_Cancer, is.character)],as.factor)
str(Breast_Cancer[,sapply(Breast_Cancer, is.factor)])
```
Con las variables bien categorizadas como factores podemos ver su distribución:
```{r}
summary(Breast_Cancer)
```
A simple vista se puede observar lo siguiente:

* La edad media es de 54 años y casi todas están entre 50 y 60 años
* Son mujeres casada en su mayoria
* De media han sobrevivido 6 años y la mayoria están vivas
* El grado del cancer en general es 2 o 3 pero la mayoria esta en unos estados más iniciales y a apenas se les ha extendido por partes distantes del cuerpo 

### Tratamiento datos faltantes
Viendo desde el summary, se observa que hay 19 N/As en algunas variables.

```{r}
sapply(Breast_Cancer, function(x) sum(is.na(x)))
```
Vemos que en alguna algunas variables hay N/A pero son muy pocas. De hecho, suponen un `r round((sum(is.na(Breast_Cancer$Regional_Node_Positive))/count(Breast_Cancer))*100,2)`% del total de los datos. Además, de estos registros no tenemos la variable respuesta (Status) con lo que optamos por eliminarlas.

```{r}
Breast_Cancer_limpio<-Breast_Cancer %>% filter(is.na(Regional_Node_Positive)==FALSE)
```


### Partición de dataset entre uno de entrenamiento (train) y otro de validación (test)
Antes de empezar con el EDA, siguiendo las buenas prácticas en la construcción de modelos, particionamos el dataset desde el principio entre uno de entrenamiento que es con el que vamos a hacer el EDA y otro de validación para que cuando tengamos el modelo ver si este predice bien sobre unos datos que no ha visto.

Para ello utilizamos la funcion de la libreria Caret.

Primero, para que sea reproducible ponemos una semilla y creamos el dataset de entrenamiento con el 70% de los datos

```{r}
set.seed(1)

particion <- sample(1:nrow(Breast_Cancer_limpio), size = 0.7 * nrow(Breast_Cancer_limpio))

Breast_Cancer_train <- Breast_Cancer_limpio[particion, ]

Breast_Cancer_test <- Breast_Cancer_limpio[-particion, ]
```

Vamos a separar las variables numéricas de las categóricas:

```{r}
Breast_Cancer_train_num <- Breast_Cancer_train[,names(which(sapply(Breast_Cancer_train, is.numeric)))]
colnames(Breast_Cancer_train_num)
```

```{r}
Breast_Cancer_train_cat <- Breast_Cancer_train[,names(which(sapply(Breast_Cancer_train, is.factor)))]
colnames(Breast_Cancer_train_cat)
```
```{r}
ncol(Breast_Cancer_train_num)
ncol(Breast_Cancer_train_cat)
```
Miramos a alto nivel como se reparte la variable respuesta en el dataset de Train:
```{r}
prop.table(table(Breast_Cancer_train$Status))
```

### Analisis variables numéricas

Primero generamos un boxplot para todas ellas:


```{r, echo=FALSE,fig.width=10,fig.height=5.5}
par(cex.axis = 0.8)
boxplot(Breast_Cancer_train_num, main = 'Boxplot de Variables Continuas',
        ylab = "Valores",col = 'ghostwhite')
```


Miramos histogramas y boxplot para cada una de ellas:

```{r echo=FALSE,warnning=FALSE,fig.width=20,fig.height=10}
vars<-c(strsplit(colnames(Breast_Cancer_train_num), ","))
# Generar un gráfico de densidad para cada variable
plots <- lapply(vars, function(x) {
  ggplot(data = Breast_Cancer_train_num, aes(x = get(x)))+
  geom_histogram(bins=20,fill="lavender", color="black",alpha = 0.9)+
  xlab(x)+  
  theme_minimal()
}
  )

# Mostrar los gráficos en una sola ventana
grid.arrange(grobs = plots, nrow = 2, ncol = 3)
```

Podemos analizar la correlacion entre estas variables pero antes vamos a incluir la variable Status de forma numerica:

```{r}
Breast_Cancer_train_num_2 <- Breast_Cancer_train_num %>% mutate(Status = ifelse(Breast_Cancer_train$Status == "Alive", 0, 1))
```

```{r}
ggcorrplot(cor(Breast_Cancer_train_num_2),type = "lower", lab=TRUE)
```



Ahora si nos centramos unicamente en la edad:
```{r}
summary(Breast_Cancer$Age)
sd(Breast_Cancer$Age)
Cv(mean(Breast_Cancer$Age), sd(Breast_Cancer$Age))
```
```{r}
x<-"Age"
ggplot(Breast_Cancer, aes(x = get(x))) +
  geom_density() +
  ggtitle(x)
ggplot(Breast_Cancer, aes(x = get(x))) +
  geom_histogram(fill="white", colour="black",bins=10) +
  ggtitle(x)
```

Analizamos si la variable Edad sigue una normal:
```{r}
normalTest(Breast_Cancer$Age, method = c("sw", "jb"))
qqnorm(Breast_Cancer$Age, pch = 1, frame = FALSE)
qqline(Breast_Cancer$Age, col = "steelblue", lwd = 2)
```
Se observa que no tiene mucha normalidad. Probamos con el logaritmo:
Analizamos si la variable Edad sigue una normal:
```{r}
normalTest(log10(Breast_Cancer$Age), method = c("sw", "jb"))
qqnorm(log10(Breast_Cancer$Age), pch = 1, frame = FALSE)
qqline(log10(Breast_Cancer$Age), col = "steelblue", lwd = 2)
```
Se sigue observando que no tiene normalidad la variable.

Vemos la variable Age por las diferentes variables categóricas:
METER BOXPLOT!!!!
```{r}
for(i in 1:ncol(Breast_Cancer.cat))
{
x<-colnames(Breast_Cancer.num)[1]
y<-colnames(Breast_Cancer.cat)[i]
lables <-levels(Breast_Cancer[,y])
names(Breast_Cancer.cat[i]) 
total<-length(Breast_Cancer[,x])

print(
Breast_Cancer %>%
  mutate(variab = factor(get(y) , labels = levels(Breast_Cancer[,y]))) %>%
  ggplot(aes(x = get(x), fill = get(y))) +
  geom_density(alpha = .3) +
  ggtitle(x)
)

print(
Breast_Cancer %>%
  mutate(variab = factor(get(y) , labels = levels(Breast_Cancer[,y]))) %>%
  ggplot(aes(x = get(y), y = get(x))) +
  geom_violin(aes(fill = get(y))) +
  ggtitle(x)
)

print(
Breast_Cancer %>%
   summarise(conteo=length(get(x)),porc=length(get(x))/total,media=mean(get(x)),median=median(get(x)),desv_tip=sd(get(x)),CoV=Cv(mean(get(x)),sd(get(x))))
)

print(
Breast_Cancer %>%
   group_by(get(y)) %>%
   summarise(conteo=length(get(x)),porc=length(get(x))/total,media=mean(get(x)),median=median(get(x)),desv_tip=sd(get(x)),CoV=Cv(mean(get(x)),sd(get(x))))
)
}
```
Vemos la variable Age por las diferentes variables numericas (scatter plots y correlaciones):



Se observa que las mujeres de raza blanca son más mayores y están algo más menos dispersos. Sin embargo, las mujeres de la muestra de raza negra y sobre todo de "Other" son más jóvenes. En cualquier caso, las mujeres de raza blanca son la clara mayoria.

Lo vemos por la variable categorica Marital Status
```{r}
y<-colnames(Breast_Cancer.cat)[2]
y
lables <-levels(Breast_Cancer[,y])
total<-length(Breast_Cancer[,x])

Breast_Cancer %>%
  mutate(variabl = factor(get(y) , labels = levels(Breast_Cancer[,y]))) %>%
  ggplot(aes(x = get(x), fill = get(y))) +
  geom_density(alpha = .3) +
  ggtitle(x)

Breast_Cancer %>%
  mutate(Marital.Status = factor(get(y) , labels = levels(Breast_Cancer[,y]))) %>%
  ggplot(aes(x = get(y), y = get(x))) +
  geom_violin(aes(fill = Marital.Status)) +
  ggtitle(x)

Breast_Cancer %>%
   summarise(conteo=length(get(x)),porc=length(get(x))/total,media=mean(get(x)),median=median(get(x)),desv_tip=sd(get(x)),CoV=Cv(mean(get(x)),sd(get(x))))

Breast_Cancer %>%
   group_by(Marital.Status) %>%
   summarise(conteo=length(get(x)),porc=length(get(x))/total,media=mean(get(x)),median=median(get(x)),desv_tip=sd(get(x)),CoV=Cv(mean(get(x)),sd(get(x))))
```
Lo vemos por la variable categorica Marital Status
```{r}
y<-colnames(Breast_Cancer.cat)[3]
y
lables <-levels(Breast_Cancer[,y])

Breast_Cancer %>%
  mutate(Marital.Status = factor(get(y) , labels = levels(Breast_Cancer[,y]))) %>%
  ggplot(aes(x = get(x), fill = Marital.Status)) +
  geom_density(alpha = .3) +
  ggtitle(x)

Breast_Cancer %>%
  mutate(Marital.Status = factor(get(y) , labels = levels(Breast_Cancer[,y]))) %>%
  ggplot(aes(x = get(y), y = get(x))) +
  geom_violin(aes(fill = Marital.Status)) +
  ggtitle(x)
```


La variables categoricas las convertimos en numericas para poder trabajar mejor
```{r}
Breast_Cancer.cat.final <- sapply(Breast_Cancer.cat,unclass)
head(Breast_Cancer.cat.final)
```
Sacamos el mapeo entre el valor numerico dado a la variable categorica y su nivel
```{r}
for(i in 1:ncol(Breast_Cancer.cat))
{
x<-colnames(Breast_Cancer.cat)[i]
print(with(Breast_Cancer.cat,data.frame(code=seq_along(levels(get(x))),levels=levels(get(x)))))
}
```




```{r}
#table(Breast_Cancer$Status)
prop.table(table(Breast_Cancer$Status))
#table(Breast_Cancer$Status,Breat_Cancer$Race)
```

```{r}
#boxplot(Breast_Cancer$Age)
hist(Breast_Cancer$Age)
```


```{r}
dim(Breast_Cancer)
```



https://github.com/carmenlancho/MDS
Iris_sinlogo ->raw->



